<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Shared head includes: CSS, JS, meta tags. -->
    <%- include('partials/header') %>
    <title>My Library - BeatsHQ</title>
</head>
<body class="bg-hero library-page">
    <!-- Top navigation with login/register or user links. -->
    <%- include('partials/navbar', {loggedin: loggedin, username: username}) %>

    <main class="container py-5">
        <div class="text-white">
            <h1 class="display-4 mb-2">My Library</h1>
            <p class="lead mb-4">Your purchased packs</p>

            <!-- Client-side search for packs and samples. -->
            <div class="library-search mb-4">
                <input type="text" class="form-control" id="librarySearchInput" placeholder="Search your library by sample or pack...">
            </div>

            <!-- Error state for library loading. -->
            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>

            <div class="row">
                <% if (!packs || packs.length === 0) { %>
                    <!-- Empty state if the user has no purchases. -->
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox icon-empty"></i>
                        <p class="mt-3 text-white">You haven't purchased any samples yet.</p>
                        <a href="/packs" class="btn btn-primary mt-3">Browse Packs</a>
                    </div>
                <% } else { %>
                    <!-- Render each owned pack with its samples. -->
                    <% packs.forEach(function(pack) { %>
                        <div class="col-12 mb-4 library-pack-header" data-pack-id="<%= pack.id %>" data-pack-name="<%= pack.name.toLowerCase() %>" data-pack-genre="<%= (pack.genre || '').toLowerCase() %>">
                            <!-- Pack Header -->
                            <div class="pack-card pack-card--row mb-3">
                                <% if (pack.cover_image) { %>
                                    <div class="pack-card__media">
                                        <img src="/public/images/pack-covers/<%= pack.cover_image %>" alt="<%= pack.name %>" class="pack-cover-img">
                                    </div>
                                <% } %>

                                <div class="pack-card__content">
                                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                                        <div>
                                            <h3 class="text-white mb-2"><%= pack.name %></h3>
                                            <% if (pack.genre) { %>
                                                <span class="badge bg-success mb-2"><%= pack.genre %></span>
                                            <% } %>
                                            <div class="pack-stats">
                                                <span>
                                                    <i class="bi bi-music-note-beamed"></i> <%= pack.sample_count %> Sample<%= pack.sample_count !== 1 ? 's' : '' %>
                                                </span>
                                            </div>
                                        </div>
                                        <a href="/packs/<%= pack.id %>" class="btn btn-outline-light btn-sm">
                                            <i class="bi bi-eye"></i> View Pack
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Owned Samples from this Pack -->
                        <div class="col-12 mb-5 library-pack-samples" data-pack-id="<%= pack.id %>">
                            <div class="row ms-2 me-2">
                                <% if (!pack.owned_samples || pack.owned_samples.length === 0) { %>
                                    <!-- Pack exists but user owns no samples in it. -->
                                    <div class="col-12">
                                        <div class="text-white-50 text-center py-3">
                                            <small><i class="bi bi-inbox"></i> No samples owned from this pack</small>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <!-- Individual owned samples in this pack. -->
                                    <% pack.owned_samples.forEach(function(sample) { %>
                                            <div class="col-md-6 col-lg-4 mb-3" data-pack-id="<%= pack.id %>" data-sample-title="<%= sample.title.toLowerCase() %>" data-sample-type="<%= (sample.type || '').toLowerCase() %>">
                                                <div class="sample-card<%= pack.cover_image ? ' sample-card--with-cover' : '' %>" style="<%= pack.cover_image ? "background-image: linear-gradient(rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0.75)), url('/public/images/pack-covers/" + pack.cover_image + "');" : "" %>">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h5 class="text-white mb-0"><%= sample.title %></h5>
                                                    <span class="badge bg-warning text-dark"><%= sample.credits %> Credit<%= sample.credits !== 1 ? 's' : '' %></span>
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <span class="badge <%= sample.type === 'loop' ? 'bg-info' : 'bg-secondary' %> me-2">
                                                        <%= sample.type === 'loop' ? 'Loop' : (sample.type === 'track' ? 'Track' : 'One-Shot') %>
                                                    </span>
                                                    <% if (sample.type === 'loop' && sample.bpm) { %>
                                                        <span class="badge bg-dark"><%= sample.bpm %> BPM</span>
                                                    <% } %>
                                                </div>
                                                
                                                <audio controls controlsList="nodownload" preload="none">
                                                    <source src="/samples/preview/<%= sample.id %>" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                </audio>
                                                
                                                <button class="btn btn-success btn-sm w-100" onclick="downloadSample('<%= sample.id %>')">
                                                    <i class="bi bi-download"></i> Download
                                                </button>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } %>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </div>
    </main>
    <%- include('partials/footer') %>
</body>
</html>
